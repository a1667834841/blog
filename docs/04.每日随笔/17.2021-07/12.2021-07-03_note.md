---
title: 2021-07-03_note
date: 2022-11-13 23:10:11
permalink: /pages/4f2a31/
categories:
  - 每日随笔
  - 2021-07
tags:
  - 
---
**mood:** :smile:  																		**date: 2021-07-03**  
## 今日计划  
------
- [x]  测试PROPAGATION_NESTED -- 如果当前存在事务，则在嵌套事务内执行
- [ ] http调用时间过长
- [x] 手动开启关闭事务
- [x] aop注解实现事务
- [x] 记录dao的sql https://blog.csdn.net/qq_36850813/article/details/83092051
- [x] flyway的命名方式
- [ ] 得到字段修改前后的变化
## 明日计划  
------
- [ ]  
## 随写 
------

```java
执行结果描述：如下例子执行结果是save方法的数据保存到了数据库，save1的数据未保存到数据库。

结果总结：save1重新启动了一个事务，其执行失败不会影响其他的事务.只是回滚自己所在事务。

接口类：UserService

package com.spring.service;

import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import com.spring.po.User;


public interface UserService{
    @Transactional(propagation=Propagation.REQUIRED)
    public void save();
    
    @Transactional(propagation=Propagation.NEW)
    public void save1();
}

接口实现类：UserServiceImpl

package com.spring.service;

import javax.sql.DataSource;

import org.springframework.jdbc.core.JdbcTemplate;

import com.spring.po.User;

public class UserServiceImpl implements UserService{
    
    private JdbcTemplate JdbcTemplate;
    

    public void setDataSource(DataSource dataSource) {
        this.JdbcTemplate = new JdbcTemplate(dataSource);
    }

    public void save(){
        JdbcTemplate.update(" insert into User(username,password) values('55555','555555') ");
    }
    
    public void save1(){
        int i=1/0;
        JdbcTemplate.update(" insert into User(username,password) values('6666666','6666666') ");
    }
}

测试类：

package com.spring.test;

import org.springframework.context.ApplicationContext;
import org.springframework.context.support.FileSystemXmlApplicationContext;

import com.spring.po.User;
import com.spring.service.UserService;

public class Test{
    
    public static void main(String[] args){
     ApplicationContext    ctx=new FileSystemXmlApplicationContext("src/applicationContext.xml");
     UserService s=(UserService)ctx.getBean("userService");
     s.save();
     s.save1();
  }
}
```

 

**PROPAGATION_REQUIRES_NEW** 启动一个新的, 不依赖于环境的 "内部" 事务. 这个事务将被完全 commited 或 rolled back 而不依赖于外部事务, 它拥有自己的隔离范围, 自己的锁, 等等. 当内部事务开始执行时, 外部事务将被挂起, 内务事务结束时, 外部事务将继续执行.


  另一方面, **PROPAGATION_NESTED** 开始一个 "嵌套的" 事务, 它是已经存在事务的一个真正的子事务. 潜套事务开始执行时, 它将取得一个 savepoint. 如果这个嵌套事务失败, 我们将回滚到此 savepoint. 潜套事务是外部事务的一部分, 只有外部事务结束后它才会被提交.

  由此可见, PROPAGATION_REQUIRES_NEW 和 PROPAGATION_NESTED 的**最大区别**在于, PROPAGATION_REQUIRES_NEW 完全是一个新的事务, 而 PROPAGATION_NESTED 则是外部事务的子事务, 如果外部事务 commit, 潜套事务也会被 commit, 这个规则同样适用于 roll back.

https://www.iteye.com/topic/35907





## 一、V(Versioned Migrations):

每个文件只会被执行一次，version必须唯一，可以用递增的组合 整型和点(.)下面都是合法的：

划重点咯，数字和点号组合合法。如果有错误请在文末指出，多谢啦！

```
1
001
5.2
1.2.3.4.5.6.7.8.9
205.68
20130115113556
2013.1.15.11.35.56
2013.01.15.11.35.56
```


常用于创建、修改、删除表；插入、修改数据等 如：

常用于创建、修改、删除表；插入、修改数据等 如：

```sql
CREATE TABLE bus (
    id INT NOT NULL PRIMARY KEY,
    license_plate VARCHAR NOT NULL,
    color VARCHAR NOT NULL
);
```

ALTER TABLE owner ADD driver_license_id VARCHAR;

INSERT INTO brand (name) VALUES ('loongshawn');

## 二、U(Undo Migrations):

回滚即rollback，与version作用相反，版本号与V一致:

```sql
DELETE FROM brand WHERE name='loongshawn'；

ALTER TABLE owner DROP driver_license_id；

DROP TABLE bus；
```



## 三、R(Repeatable Migrations):

校验和变化了就会执行，可以用于存放view/procedures/functions/packages…

执行顺序：在所有Version执行完了才会执行，自身执行顺序按描述排序。

因为会执行多次，编写DDL语句时需加上CREATE OR REPLACE。如：

```sql
CREATE OR REPLACE VIEW blue_bus AS 
    SELECT id, license_plate FROM bus WHERE color='blue';

```


