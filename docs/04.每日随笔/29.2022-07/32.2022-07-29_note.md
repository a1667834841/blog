---
title: 2022-07-29_note
date: 2022-11-13 23:10:12
permalink: /pages/fb35a3/
categories:
  - 每日随笔
  - 2022-07
tags:
  - 
---
**mood:** :smile:  									**date: 2022-07-29**  
## 今日计划  
------
- [ ]  
- [ ]  15个单词
## 明日计划  
------
- [ ]  
## 随写 
------

ThreadLocal 内存泄露的原因



![img](https://segmentfault.com/img/remote/1460000022704088)

首先明白ThreadLocal和TheadLocalMap,Entry的关系

当线程结束时，因为 ThreadLocal标记为WeakReference弱引用，堆里面的ThreadLocal会被下一次GC扫描并回收掉，

但是Entry中的value存在强引用，所以可能会造成内存泄露。

> **当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象**。



解决办法：

手动释放资源

```java
ExecutorService es;
ThreadLocal tl;
es.execute(()->{
  //ThreadLocal 增加变量
  tl.set(obj);
  try {
    // 省略业务逻辑代码
  }finally {
    // 手动清理 ThreadLocal 
    tl.remove();
  }
});
```

