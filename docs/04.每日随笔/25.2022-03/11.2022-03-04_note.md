---
title: 2022-03-04_note
date: 2022-11-13 23:10:11
permalink: /pages/ee0396/
categories:
  - 每日随笔
  - 2022-03
tags:
  - 
---
**mood:** :smile:  									**date: 2022-03-04**  
## 今日计划  
------
- [ ]  写sql恢复核销金额(订单详情，售后详情，核销单)
- [ ]  
## 明日计划  
------
- [ ]  
## 随写 
------







## undo日志

作用：处于事务回滚的需要，需要记录未提交的数据库操作，方便回滚事务，记录未提交的数据库操作的文件就是undo日志。



## 事务id

### 分配事务id的时机

开启事务的时候（包括开启可读事务和读写事务），如果某个事务执行过程中对某个表执行了增、删、改操作，那么 InnoDB 存储引擎就会给它分配一个独一无二的`事务id `。

**注意：可读事务只有在对临时表做增删改操作的时候，才会被分配`事务id`**



### 生成事务id的过程

类似隐藏列`raw_id`的生成

1. 服务器会在内存中维护一个全局变量，每当需要为某个事务分配一个 事务id 时，就会把该变量的值当作 事务id 分配给该事务，并且把该变量自增1。
2. 每当这个变量的值为 256 的倍数时，就会将该变量的值刷新到系统表空间的页号为 5 的页面中一个称之为Max Trx ID 的属性处，这个属性占用 8 个字节的存储空间。
3. 当系统下一次重新启动时，会将上边提到的 Max Trx ID 属性加载到内存中，将该值加上256之后赋值给我们前边提到的全局变量（因为在上次关机时该全局变量的值可能大于 Max Trx ID 属性值）。

这样就可以保证整个系统中分配的 事务id 值是一个**递增**的数字。先被分配 id 的事务得到的是较小的 事务id ，后被分配 id 的事务得到的是较大的 事务id 。



trx_id隐藏列

我们前边唠叨 InnoDB 记录行格式的时候重点强调过：**聚簇索引的记录除了会保存完整的用户数据以外，而且还会自动添加名为trx_id、roll_pointer的隐藏列，如果用户没有在表中定义主键以及UNIQUE键，还会自动添加一个名为row_id的隐藏列**。所以一条记录在页面中的真实结构看起来就是这样的：

![image-20220304114439955](https://img.ggball.top/picGo/image-20220304114439955.png)

其中的 trx_id 列其实还蛮好理解的，就是某个对这个聚簇索引记录做改动的语句所在的事务对应的 `事务id `而已（此处的改动可以是 INSERT 、 DELETE 、 UPDATE 操作）

## undo日志格式