---
title: 2022-01-19_note
date: 2022-11-13 23:10:11
permalink: /pages/1ddbc5/
categories:
  - 每日随笔
  - 2022-01
tags:
  - 
---
**mood:** :smile:  									**date: 2022-01-19**  
## 今日计划  
------
- [ ]  粘包，拆包在netty中是什么场景
## 明日计划  
------
- [ ]  
## 随写 
------

netty

### Netty 整体结构

![image-20220119130949728](https://img.ggball.top/picGo/image-20220119130949728.png)

1. core 核心层（提供了底层网络通信的通用抽象和实现）
2. protocol support 协议支持层（负责主流协议的编解码工作）
3. transport service 传输服务层（提供了网络传输能力的定义和实现方法）



### Netty 逻辑架构

![image-20220119131401911](https://img.ggball.top/picGo/image-20220119131401911.png)

1. 网络通信层（负责**执行网络io**的操作）
2. 事件调度层（事件调度层的职责是通过 Reactor 线程模型对各类事件进行**聚合处理**，通过 Selector **主循环线程集成多种事件**（ I/O 事件、信号事件、定时事件等），实际的业务处理逻辑是**交由服务编排层**中相关的 Handler 完成。）

3. 服务编排层（负责**组装各类服务**，它是 Netty 的核心处理链，用以**实现**网络事件的**动态编排和有序传播**）



### 组件关系梳理

![image-20220120160156738](https://img.ggball.top/picGo/image-20220120160156738.png)

- 服务端启动初始化时有 Boss EventLoopGroup 和 Worker EventLoopGroup 两个组件，其中 Boss 负责监听网络连接事件。当有新的网络连接事件到达时，则将 Channel 注册到 Worker EventLoopGroup。
- Worker EventLoopGroup 会被分配一个 EventLoop 负责处理该 Channel 的读写事件。每个 EventLoop 都是单线程的，通过 Selector 进行事件循环。
- 当客户端发起 I/O 读写事件时，服务端 EventLoop 会进行数据的读取，然后通过 Pipeline 触发各种监听器进行数据的加工处理。
- 客户端数据会被传递到 ChannelPipeline 的第一个 ChannelInboundHandler 中，数据处理完成后，将加工完成的数据传递给下一个 ChannelInboundHandler。
- 当数据写回客户端时，会将处理结果在 ChannelPipeline 的 ChannelOutboundHandler 中传播，最后到达客户端。

### Netty 源码结构

![image-20220120160217538](https://img.ggball.top/picGo/image-20220120160217538.png)

#### Core 核心层模块

**netty-common**模块是 Netty 的核心基础包，提供了丰富的工具类，其他模块都需要依赖它。在 common 模块中，常用的包括**通用工具类**和**自定义并发包**。

- 通用工具类：比如定时器工具 TimerTask、时间轮 HashedWheelTimer 等。
- 自定义并发包：比如异步模型****Future & Promise、相比 JDK 增强的 FastThreadLocal 等。

在**netty-buffer 模块中**Netty自己实现了的一个更加完备的**ByteBuf 工具类**，用于网络通信中的数据载体。由于人性化的 Buffer API 设计，它已经成为 Java ByteBuffer 的完美替代品。ByteBuf 的动态性设计不仅解决了 ByteBuffer 长度固定造成的内存浪费问题，而且更安全地更改了 Buffer 的容量。此外 Netty 针对 ByteBuf 做了很多优化，例如缓存池化、减少数据拷贝的 CompositeByteBuf 等。

**netty-resover**模块主要提供了一些有关**基础设施**的解析工具，包括 IP Address、Hostname、DNS 等。



#### Protocol Support 协议支持层模块

**netty-codec**模块主要负责编解码工作，通过编解码实现原始字节数据与业务实体对象之间的相互转化。如下图所示，Netty 支持了大多数业界主流协议的编解码器，如 HTTP、HTTP2、Redis、XML 等，为开发者节省了大量的精力。此外该模块提供了抽象的编解码类 ByteToMessageDecoder 和 MessageToByteEncoder，通过继承这两个类我们可以轻松实现自定义的编解码逻辑。

**netty-handler**模块主要负责数据处理工作。Netty 中关于数据处理的部分，本质上是一串有序 handler 的集合。netty-handler 模块提供了开箱即用的 ChannelHandler 实现类，例如日志、IP 过滤、流量整形等，如果你需要这些功能，仅需在 pipeline 中加入相应的 ChannelHandler 即可。



#### Transport Service 传输服务层模块

netty-transport 模块可以说是 Netty 提供数据**处理和传输的核心模块**。该模块提供了很多非常重要的接口，如 Bootstrap、Channel、ChannelHandler、EventLoop、EventLoopGroup、ChannelPipeline 等。其中 Bootstrap 负责客户端或服务端的启动工作，包括创建、初始化 Channel 等；EventLoop 负责向注册的 Channel 发起 I/O 读写操作；ChannelPipeline 负责 ChannelHandler 的有序编排，这些组件在介绍 Netty 逻辑架构的时候都有所涉及。