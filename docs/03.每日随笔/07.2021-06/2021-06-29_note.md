---
title: 2021-06-29_note
date: 2021-10-08 19:46:05
permalink: /pages/58e0dc/
categories:
  - 每日随笔
  - 2021-06
tags:
  - 
---
**mood:** :smile:  																		**date: 2021-06-29**  
## 今日计划  
------
- [ ]  推节假日订单 添加提示（判断有没有已申请发票，未推送的）
- [ ]  推发票 地址去除<> nc把正式环境vdef14字段改为500长度
- [ ]  礼券订单推送nc 修改提示
## 明日计划  
------
- [ ]  
## 随写 
------

```
       // 检查订单是否被开票，且发票没有被开票

            List<InvoiceInfo> invoiceInfoList = invoiceInfoDao.selectNotInvoicedByOrderBillId(orderBillId);
            if (Lists.isNotNullOrEmpty(invoiceInfoList)) {
                // 查看订单关联的发票有无推送记录
                List<Long> invoiceIdList = invoiceInfoList.stream().map(invoiceInfo -> invoiceInfo.getId()).collect(Collectors.toList());
                int count = orderNcDao.selectInOrderBillId(invoiceIdList);
                if (invoiceInfoList.size() == count) {
                    log.error("该订单：{}绑定的发票全部已推送",orderBillId);
                } else {
                    log.error("该订单：{}绑定的未开票的发票数量不为0，请先开票：{}",orderBillId, JSONObject.toJSONString(invoiceInfoList));
                    tipBuffer.append("该订单："+orderBillId+"绑定的未开票的发票数量不为0,未开票发票id:");
                    for (InvoiceInfo invoiceInfo : invoiceInfoList) {
                        tipBuffer.append(invoiceInfo.getId());
                    }
                }

            }
            
            
              /***
     *
     * 描述: 查询订单被开票且开票状态为待开票的发票
     * @param orderBillId 订单id
     * @date 2021/6/24 10:14
     * @author ggball
     * @return List<InvoiceInfo>
     */
    List<InvoiceInfo> selectNotInvoicedByOrderBillId(String orderBillId);
    
      <select id="selectNotInvoicedByOrderBillId" resultType="com.daoism.biz.entity.invoice.InvoiceInfo">
    select *  from tb_invoice_info
    <where>
      <if test="orderBillId != null and orderBillId != ''">
       and  orderBillId like CONCAT('%', #{orderBillId}, '%')
      </if>
      and state = 0
    </where>
  </select>
  
    SELECT count(1)
    FROM tb_consume_order_nc
    <where>
      orderBillId in
      <foreach collection="invoiceIdList" item="invoiceId" open=" ( " close=" ) " separator=",">
        #{invoiceId}
      </foreach>
      AND resultType = '0'
    </where>
```

```
DBCLX20210629048220
未兑换
DBCLX20210629066912
未兑换
DBCLX20210629164887
未兑换
DBCLX20210629286539
未兑换
DBCLX20210629303161
未兑换
DBCLX20210629712800
未兑换
DBCLX20210629791354
未兑换
DBCLX20210629805080
未兑换
DBCLX20210629921575
未兑换
DBCLX20210629924435
```

