---
title: 2021-08-22_note
date: 2021-10-08 19:46:05
permalink: /pages/94e1d9/
categories:
  - 每日随笔
  - 2021-08
tags:
  - 
---
**mood:** :smile:  																		**date: 2021-08-22**  

## 今日计划  
------
- [x]  锁表原因
- [ ]  mall
- [ ]  第五章tomcat
## 明日计划  
------
- [ ]  
## 随写 
------

mysql的默认引擎是innodb,关于行锁表锁

接下来要分析一个问题：什么时候用的行锁，什么时候用的表锁，有以下几种情况：

1、在有索引的情况下主键索引与非主键索引加的哪种锁

2、在无索引的情况下加的哪种锁

注意事项：

该操作要在两个命令窗口进行，因为加锁要放在begin/commit的事务中，在提交之前

mysql都是默认提交，要先取消：set @@autocommit=0 （autocommit标志是针对每个连接而不是服

务器的）



主键索引

修改不同记录

1. 开启两个mysql连接(A连接，B连接)，都取消默认提交,都使用同一张表。
2. A连接，开启事务，并执行 `select * from user where id =11 for UPDATE` 操作。

![A连接](https://gitee.com/zxqzhuzhu/imgs/raw/master/picGo/image-20210822155522816.png)

3. B连接，开启事务，并执行 select * from user where id =12 for UPDATE 操作

![image-20210822155856112](https://gitee.com/zxqzhuzhu/imgs/raw/master/picGo/image-20210822155856112.png)

4. A连接，提交事务；B连接，提交事务。



结论： 说明使用InnoDB，更新主键索引时，不是使用表锁。因为A连接没有提交时，B连接依然可以对其他记录进行update操作。



修改同一条记录

1. 开启两个mysql连接(A连接，B连接)，都取消默认提交,都使用同一张表。

2. A连接，开启事务，并执行 `select * from user where id =11 for UPDATE` 操作。

   ![A连接](https://gitee.com/zxqzhuzhu/imgs/raw/master/picGo/image-20210822155522816.png)

3. B连接，开启事务，并执行 select * from user where id =11 for UPDATE 操作

![image-20210822165253467](https://gitee.com/zxqzhuzhu/imgs/raw/master/picGo/image-20210822165253467.png)

结论：当B连接准备修改A连接修改的那条数据，提示锁表了，说明更新索引列时，InnoDB会锁行，不会锁表。



使用非索引时

修改不同记录

1. 开启两个mysql连接(A连接，B连接)，都取消默认提交,都使用同一张表。
2. A连接，开启事务，并执行 select * from user where name = 'sss1' for UPDATE 操作。

![image-20210822170620590](https://gitee.com/zxqzhuzhu/imgs/raw/master/picGo/image-20210822170620590.png)

3. B连接，开启事务，并执行 select * from user where name = 'wupx1' for UPDATE 操作

![image-20210822170651839](https://gitee.com/zxqzhuzhu/imgs/raw/master/picGo/image-20210822170651839.png)

结论：两个连接修改的是同一张表的不同记录，但是B连接修改失败了，说明使用非索引列更新会锁表

在 select，update 和 delete 的时候，where 条件如果不存在索引字段(只有主键和唯一索引才是行锁，普通索引是表锁)，那么这个事务会导致表锁。

　在 select，update 和 delete 的时候，where 条件如果不存在索引字段，那么这个事务会导致表锁（**当“值重复率”低时，甚至接近主键或者唯一索引的效果，“普通索引”依然是行锁；当“值重复率”高时，MySQL 不会把这个“普通索引”当做索引，即造成了一个没有索引的 SQL，此时引发表锁**。）