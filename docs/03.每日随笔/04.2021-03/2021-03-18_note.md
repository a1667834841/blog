---
title: 2021-03-18_note
date: 2021-10-08 19:46:05
permalink: /pages/c5d8e0/
categories:
  - 每日随笔
  - 2021-03
tags:
  - 
---


**mood:** :smile:  																		**date: 2021-03-18**  

## 今日计划  
------
- [ ]  
## 明日计划  
------
- [ ]  
## 随写

------

```

pm2 start "yarn run serve" --name "xflowchart" -- start .



/**
 * @param start    开始时间
 * @param end      结束时间
 * @param dateType 时间类型 day 天 hour小时
 * @Description aqi分析
 * @Author ggBall
 * @Date 2020/12/3 11:10
 * @Param
 * @Return com.linktopa.framework.common.model.response.ResponseResult
 * @Exception
 */
@Override
public ResponseResult aqiAnalysisByType(Long start, Long end, String dateType) {

    try {

        MultipartData result = new MultipartData();

        // 大气站点类型
        int airSiteType = 1;
        // 根据时间类型 查询大气的表
        TableNameEnum table = TableNameEnum.getTable(airSiteType, dateType);

        if (Values.isNull(table) || Values.isNull(table.getTableName())) {
            return DataFactory.createFail().withMes("aqiAnalysisByType table not found").build();
        }


        // 查询因子
        Map<Integer, List<Factor>> factorMap = factorMapper.selectList(null).stream().collect(Collectors.groupingBy(Factor::getId));
        // 时间转换
        Timestamp startDate = DateUtils.getDateFormat(start, DateUtils.DefaultType.FORMAT_DEFAULT);
        Timestamp endDate = DateUtils.getDateFormat(end, DateUtils.DefaultType.FORMAT_DEFAULT);
        // 查询 当天aqi信息
        List<MultipartData> aqiList = airRawMapper.queryAqiData(startDate,endDate,table.getTableName());

        if (Lists.isNullOrEmpty(aqiList)) {
            log.warn("aqiList is null");
            return DataFactory.createFail().withMes("aqiList is null").build();
        }
        // aqi信息根据时间分组 时间升序
        Map<Date, List<MultipartData>> sampleTimeMap = aqiList.stream().collect(Collectors.groupingBy(item -> item.getDatePart("sampleTime"),TreeMap::new,Collectors.toList()));
        // 取最后一点的数据
        Set<Date> dates = sampleTimeMap.keySet();
        Date[] dateArr = dates.toArray(new Date[dates.size()]);
        List<MultipartData> lastTimeAqiList = sampleTimeMap.get(dateArr[dateArr.length - 1]);

        // 计算aqi
        double aqi = 0.0;
        if (Lists.isNullOrEmpty(lastTimeAqiList)) {
            log.warn("lastTimeAqiList is null");
        } else {
            MultipartData aqiData = lastTimeAqiList.stream()
                    .filter(item ->  Values.isNotNull(item.getDoublePart("iaqi")))
                    .max(Comparator.comparing(item -> item.getDoublePart("iaqi"))).get();
            if (Values.isNotNull(aqiData)) {
                aqi = aqiData.getDoublePart("iaqi") == null ? 0.0 : aqiData.getDoublePart("iaqi");
            }

            log.info("aqi 成功获取");
        }

        // 获取空气质量等级
        Integer level = 0;
        aqiRange.add(aqi);
        aqiRange.sort((n1,n2) -> n1.compareTo(n2));
        level = aqiRange.indexOf(aqi);

        // 根据等级获取空气质量信息
        QueryWrapper<AirQuality> airQualityQueryWrapper = new QueryWrapper<>();
        airQualityQueryWrapper.lambda().eq(AirQuality::getLevel,level);
        AirQuality airQuality = airQualityMapper.selectOne(airQualityQueryWrapper);


        // 转备aqi模拟数据
        //aqi补齐数据

         List<MultipartData> aqiMakeUpData = new LinkedList<>();
        for (String polName : POL_NAMES) {
            MultipartData data = new MultipartData();
            data.include("polName",polName);
            data.include("avgVal",0);
            data.include("iaqi",0);
            aqiMakeUpData.add(data);
        }
        // 补齐时间范围内，没有的数据 例如 1点到17点 5点没有数据，需要补齐
        for (int i = 0; i < 24; i++) {

            // 得到时间
            Date hour = DateUtils.getTimeInDayByHour(i);
            List<MultipartData> list = sampleTimeMap.get(hour);
            // 该时间数据不为空，不做操作
            if (Lists.isNotNullOrEmpty(list)) {
                continue;
            }
            // 进行数据补齐
            sampleTimeMap.put(hour,aqiMakeUpData);
        }

        result.include("airData",sampleTimeMap);
        result.include("aqi",aqi);
        result.include("airQuality",airQuality);

        return DataFactory.createSuccess().withData(result);
    }catch (Exception e){
        e.printStackTrace();
        log.error("e:{}",e);
        return DataFactory.createError().build();
    }


}
```