---
title: AQSè§£æ
date: 2021-06-03 13:42:07
permalink: /pages/357f9d/
categories:
  - çŸ¥è¯†åº“
  - åŸºç¡€çŸ¥è¯†
  - javaå¹¶å‘ç¼–ç¨‹
tags:
  - 
---

> AQSä¸€ç›´æ˜¯æˆ‘å¤šçº¿ç¨‹ä¸Šä¸å¯é€¾è¶Šçš„é¸¿æ²Ÿï¼Œæ¯å½“æ‹¿èµ·ã€ŠJavaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ã€‹çœ‹åˆ°è¿™é‡Œå°±ä¼šå‘¼å‘¼å¤§ç¡ğŸ˜¢,è¿™æ¬¡ä¸“é—¨åšä¸ªè®°å½•ï¼Œåé¢å¤ä¹ ç”¨ã€‚

![æ¦‚è§ˆ](https://img.ggball.top/picGo/20230604173417.png)


## ä»€ä¹ˆæ˜¯AQS
AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ˜¯Javaå¹¶å‘åŒ…ï¼ˆjava.util.concurrentï¼‰ä¸­æä¾›çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒæä¾›äº†ä¸€ç§å®ç°åŒæ­¥å™¨ï¼ˆSynchronizerï¼‰çš„æ¡†æ¶ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
æä¾›åŒæ­¥çŠ¶æ€çš„ç®¡ç†åŠŸèƒ½ï¼Œå­ç±»é€šè¿‡è·å–åŒæ­¥çŠ¶æ€æ¥è¾¾åˆ°çº¿ç¨‹åŒæ­¥çš„ç›®çš„

**ä¸»è¦ç»“æ„ï¼š**
ä½¿ç”¨äº†ä¸€ä¸ª int æˆå‘˜å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼ŒAQSä¾èµ–åŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«äº†çº¿ç¨‹å’Œç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯ï¼Œå½“çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼Œä¼šå°†çº¿ç¨‹å’Œç­‰å¾…ä¿¡æ¯å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶å­˜æ”¾åˆ°é“¾è¡¨å°¾éƒ¨ï¼›å½“é¦–èŠ‚ç‚¹è¢«é‡Šæ”¾æ—¶ï¼Œä¼šé€šçŸ¥å®ƒçš„åç»§èŠ‚ç‚¹è·å–åŒæ­¥çŠ¶æ€ã€‚

**ä¸»è¦æ–¹æ³•ï¼š**

åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•åŸºæœ¬ä¸Šåˆ†ä¸º 3 ç±»ï¼š
1. ç‹¬å å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚
2. å…±äº«å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚   
3. æŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µã€‚


![å¯é‡å†™æ–¹æ³•](https://img.ggball.top/picGo/20230604144845.png)

![æ¨¡æ¿æ–¹æ³•](https://img.ggball.top/picGo/20230604144914.png)


> æ³¨æ„ï¼š
> synchronizedæ˜¯JVMå±‚é¢çš„ï¼ŒAQSæ˜¯javaä»£ç å±‚é¢çš„
> ä½¿ç”¨synchronizedå…³é”®å­—ä¼šæœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š
> 1.éå…¬å¹³é”é€ æˆé”é¥¥é¥¿ï¼›
> 2.å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œéœ€è¦é€šçŸ¥åŒæ­¥é˜Ÿåˆ—ä¸­æ‰€æœ‰çº¿ç¨‹ä½¿å…¶å˜ä¸ºå‡†å¤‡çŠ¶æ€ã€‚
> è€ŒAQSåˆ©ç”¨åŒå‘é“¾è¡¨ï¼Œå®ç°å…¬å¹³é”ï¼Œä¸ä¼šé€ æˆé”é¥¥é¥¿ï¼Œæ¯ä¸ªçº¿ç¨‹åªçœ‹è‡ªå·±çš„å‰é©±èŠ‚ç‚¹çš„é”çŠ¶æ€ï¼Œå½“é”é‡Šæ”¾æ—¶ï¼Œåªä¼šé€šçŸ¥åç»§èŠ‚ç‚¹ï¼Œå‡å°‘cpuçš„å¼€é”€ã€‚

## åˆ©ç”¨AQS,ç®€å•å®ç°ç‹¬å é”

ä¸Šé¢ç¨å¾®äº†è§£ä¸‹AQSçš„æ¦‚å¿µï¼Œå…ˆä¸»è¦çœ‹ä¸‹åˆ©ç”¨AQSç®€å•å®ç°ç‹¬å é”ï¼Œå¯ä»¥æ›´å¥½çš„äº†è§£AQSåŸç†

```java
/**
 * è‡ªå®šä¹‰é” å®ç°lockæ¥å£
 */
public class SelfLock implements Lock {


    /**
     * åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰åŒæ­¥å™¨
     */
    private static class Sync extends AbstractQueuedSynchronizer {

        /**
         * å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›false
         *
         * @param arg the acquire argument. This value is always the one
         *            passed to an acquire method, or is the value saved on entry
         *            to a condition wait.  The value is otherwise uninterpreted
         *            and can represent anything you like.
         * @return
         */
        @Override
        protected boolean tryAcquire(int arg) {

            // å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥ï¼ŒæœŸå¾…å€¼æ˜¯0ï¼Œè®¾ç½®æˆ1ï¼Œè®¾ç½®æˆåŠŸï¼Œå¯ä»¥è¿”å›true
            if (compareAndSetState(0, arg)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }

        /**
         * å°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œé‡Šæ”¾æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›false
         * @param arg the release argument. This value is always the one
         *        passed to a release method, or the current state value upon
         *        entry to a condition wait.  The value is otherwise
         *        uninterpreted and can represent anything you like.
         * @return
         */
        @Override
        protected boolean tryRelease(int arg) {
            if (getState() == arg) {
                throw new IllegalMonitorStateException();
            }
            setExclusiveOwnerThread(null);
            setState(arg);
            return true;
        }

        /**
         * åˆ›å»ºä¸€ä¸ªconditionï¼Œç±»ä¼¼äºwaitå’Œnotify
         * @return
         */
        public Condition newCondition() {
            return new ConditionObject();
        }
    }



    /**
     * åˆ›å»ºä¸€ä¸ªç§æœ‰çš„ï¼Œä¸å¯å˜çš„åŒæ­¥å™¨
     */
    private final Sync sync = new Sync();

    /**
     * åŠ é”æ“ä½œ
     */
    @Override
    public void lock() {
        sync.acquire(1);
    }

    /**
     * åŠ é”æ“ä½œï¼Œå¯ä¸­æ–­
     * @throws InterruptedException
     */
    @Override
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }

    /**
     * å°è¯•åŠ é”ï¼Œä¸æˆåŠŸè¿”å›false
     * @return
     */
    @Override
    public boolean tryLock() {
        return sync.tryAcquire(1);
    }

    /**
     * å°è¯•åŠ é”ï¼Œå¸¦è¶…æ—¶æ—¶é—´
     * @param time the maximum time to wait for the lock
     * @param unit the time unit of the {@code time} argument
     * @return
     * @throws InterruptedException
     */
    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireNanos(1, unit.toNanos(time));
    }

    /**
     * è§£é”æ“ä½œ
     */
    @Override
    public void unlock() {
        sync.release(0);
    }

    /**
     * åˆ›å»ºä¸€ä¸ªconditionï¼Œç±»ä¼¼äºwaitå’Œnotify
     */
    @Override
    public Condition newCondition() {
        return sync.newCondition();
    }
}


```
åˆ›å»ºä¸€ä¸ªé™æ€çš„ç§ç”¨`Sync`ç±»ï¼Œç»§æ‰¿`AbstractQueuedSynchronizer `å®ç°åŒæ­¥å™¨æ–¹æ³•ã€‚è‡ªå®šä¹‰çš„`SelfLock `å®ç°`Lock`æ¥å£ï¼Œ`Lock`æ¥å£çš„æ–¹æ³•éƒ½ç”±åŒæ­¥å™¨çš„æ–¹æ³•å®ç°ã€‚
å°±æ‹¿`tryLock`æ–¹æ³•ä¸¾ä¾‹ï¼Œå†…éƒ¨ç”±`Sync`ç±»çš„`tryAcquire`å®ç°ï¼Œ`tryAcquire`æ–¹æ³•å®ç°åŸç†æ˜¯åˆ©ç”¨`cas`è·å–åŒæ­¥å™¨çš„åŒæ­¥çŠ¶æ€ï¼Œè·å–æˆåŠŸåˆ™åŠ é”æˆåŠŸï¼Œè®¾ç½®å½“å‰ä¿¡æ¯ï¼Œåä¹‹åˆ™å¤±è´¥ã€‚
> è¿™é‡Œä½¿ç”¨åˆ°äº†æ¨¡æ¿æ¨¡å¼ï¼Œå½“Lockå­ç±»å®ç°å¥½åï¼ŒåŸºæœ¬ä¸éœ€è¦æ”¹åŠ¨ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹åŠ é”é€»è¾‘ï¼Œä¹Ÿåªæ˜¯ä¿®æ”¹åŒæ­¥å™¨å­ç±»çš„æ–¹æ³•ã€‚


æµ‹è¯•æ–¹æ³•
```java
public class SelfLockTest {
    static Lock lock = new SelfLock();
    public static void main(String[] args) throws InterruptedException {
        Thread A = new Thread(() -> {
            testLock();
        });
        Thread B = new Thread(() -> {
            testLock();
        });
        A.setName("I am A");
        B.setName("I am B");
        A.start();
        Thread.sleep(100);
        B.start();
    }
    public static void testLock() {
        System.out.println("I want INã€‚ã€‚ã€‚ã€‚");
        lock.lock();
        try {
            System.out.println("æˆ‘è·å–åˆ°é”äº†ï¼Œå“ˆå“ˆï¼çº¿ç¨‹åç§° = "
                    + Thread.currentThread().getName());
            while (true) {

            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}

```

## AQSåŸç†

### åˆ©ç”¨åŒæ­¥é˜Ÿåˆ—å®ç°çº¿ç¨‹é—´çš„åŒæ­¥

åˆšåˆšä¸Šé¢åªæ˜¯ç®€å•ä½¿ç”¨AQSå®ç°äº†ä¸€ä¸ªåŒæ­¥å™¨ï¼Œç”¨æ¥è¾¾åˆ°çº¿ç¨‹åŒæ­¥çš„ç›®çš„ã€‚é‚£AQSå¦‚ä½•åˆ©ç”¨åŒæ­¥é˜Ÿåˆ—å®ç°çº¿ç¨‹ä¹‹é—´å¦‚ä½•åŒæ­¥çš„å‘¢ï¼Ÿéœ€è¦å†åˆ†æä¸‹

![åŒæ­¥é˜Ÿåˆ—ç»“æ„å›¾](https://img.ggball.top/picGo/20230604151956.png)

![nodeèŠ‚ç‚¹ä¿¡æ¯](https://img.ggball.top/picGo/20230604153515.png)


å°±æ‹¿`acquire`æ–¹æ³•ä¸¾ä¾‹æŠŠ
```java
    public final void acquire(int arg) {
        if (!tryAcquire(arg) &&
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }

```

1. é¦–å…ˆçº¿ç¨‹ä¼šå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯state,å¦‚æœè·å–æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœè·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼ˆå¯¹åº”æ–¹æ³•`tryAcquire`ï¼‰
2. å°†çº¿ç¨‹ä¿¡æ¯å’Œé”çŠ¶æ€ä¿¡æ¯å°è£…æˆnodeèŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯åˆ©ç”¨casåŠ å…¥åŒå‘é“¾è¡¨å°¾éƒ¨ï¼Œï¼ˆå¯¹åº”æ–¹æ³•`addWaiter`ï¼‰æˆä¸ºå°¾èŠ‚ç‚¹æˆåŠŸåï¼ŒèŠ‚ç‚¹å†…éƒ¨ä¼šåˆ¤æ–­å‰é©±èŠ‚ç‚¹æ˜¯å¦æ—¶å¤´èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼ˆå¯¹åº”æ–¹æ³•`acquireQueued`ï¼‰ï¼Œå¦‚æœä¸æ˜¯åˆ™é˜»å¡è¯¥çº¿ç¨‹ã€‚
3. å½“å¤´èŠ‚ç‚¹é‡Šæ”¾é”æ—¶ï¼Œåç»§èŠ‚ç‚¹ä¼šå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™å°†è‡ªå·±è®¾ç½®æˆå¤´èŠ‚ç‚¹ã€‚å¯¹åº”æ–¹æ³•`acquireQueued`ï¼‰





### é‡Šæ”¾é”

```java
    public final boolean release(int arg) {
        if (tryRelease(arg)) {
            Node h = head;
            if (h != null && h.waitStatus != 0)
                unparkSuccessor(h);
            return true;
        }
        return false;
    }
```
å…ˆå°è¯•é‡Šæ”¾é”ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™è¿”å›trueï¼Œä¸»è¦è°ƒç”¨äº†LockSupport.unpark å”¤é†’é˜»å¡çŠ¶æ€çš„çº¿ç¨‹ã€‚
éœ€è¦äº†è§£ LockSupport 
![LockSupportæ–¹æ³•](https://img.ggball.top/picGo/20230604160952.png)


## Condition

ç»“æ„ç”±å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—æ„æˆ

### await

```java
            if (Thread.interrupted())
                throw new InterruptedException();
            Node node = addConditionWaiter();
            long savedState = fullyRelease(node);
```

è§£é‡Šï¼šæ”¯æŒå“åº”ä¸­æ–­ï¼Œæ„å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œé‡Šæ”¾é”ï¼ˆä¿®æ”¹åŒæ­¥çŠ¶æ€ï¼‰


### signal

```java
        public final void signal() {
            if (!isHeldExclusively())
                throw new IllegalMonitorStateException();
            Node first = firstWaiter;
            if (first != null)
                doSignal(first);
        }
```

è§£é‡Šï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ‹¥æœ‰ç‹¬å é”ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹å”¤é†’ï¼Œï¼ˆåˆ©ç”¨enqæ–¹æ³•å°†èŠ‚ç‚¹ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œä½¿ç”¨LockSupportå·¥å…·å°†å…¶å”¤é†’ï¼‰

## æ€»ç»“
æ€»çš„æ¥è¯´ï¼ŒAQSå’Œsynchronizedå…³é”®å­—å¾ˆç±»ä¼¼ï¼Œéƒ½æ˜¯æœ‰åŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ©ç”¨åŒæ­¥é˜Ÿåˆ—å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œç­‰å¾…é˜Ÿåˆ—å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ˆAQSçš„ç­‰å¾…é˜Ÿåˆ—æ˜¯ç”±Conditionä½“ç°çš„ï¼Œä¸‹æ¬¡ä»‹ç»ï¼‰ï¼ŒAQSçš„ä¼˜ç‚¹æ˜¯ï¼š
1. åŠ é”å’Œé‡Šæ”¾é”æ›´åŠ çµæ´»ï¼Œå¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿå¯ä»¥è®¾ç½®æˆå¯ä¸­æ–­åŠ é”
2. AQSå¯ä»¥è‡ªç”±å®ç°å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚
3. AQSåº•å±‚éƒ½æ˜¯åˆ©ç”¨casè®¾ç½®å€¼ï¼Œé¿å…äº†çº¿ç¨‹ç”¨æˆ·æ€åˆ°å†…æ ¸æ€ä¹‹é—´çš„è½¬æ¢ï¼Œå‡å°‘CPUå¡é¡¿