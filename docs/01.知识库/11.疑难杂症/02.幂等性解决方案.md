## 一、什么是幂等性
幂等是一个数学与计算机学概念，在数学中某一元运算为幂等时，**其作用在任一元素两次后会和其作用一次的结果相同**。在计算机中编程中，一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数或幂等方法是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。
## 二、什么是接口幂等性
在HTTP/1.1中，对幂等性进行了定义。**它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果（网络超时等问题除外），即第一次请求的时候对资源产生了副作用，但是以后的多次请求都不会再对资源产生副作用**。这里的副作用是不会对结果产生破坏或者产生不可预料的结果。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。
## 三、为什么需要实现幂等性
在接口调用时一般情况下都能正常返回信息不会重复提交，不过在遇见以下情况时可以就会出现问题，如：


- **前端重复提交表单：** 在填写一些表格时候，用户填写完成提交，很多时候会因网络波动没有及时对用户做出提交成功响应，致使用户认为没有成功提交，然后一直点提交按钮，这时就会发生重复提交表单请求。


- **用户恶意进行刷单：** 例如在实现用户投票这种功能时，如果用户针对一个用户进行重复提交投票，这样会导致接口接收到用户重复提交的投票信息，这样会使投票结果与事实严重不符。


- **接口超时重复提交：** 很多时候 HTTP 客户端工具都默认开启超时重试的机制，尤其是第三方调用接口时候，为了防止网络波动超时等造成的请求失败，都会添加重试机制，导致一个请求提交多次。


- **消息进行重复消费：** 当使用 MQ 消息中间件时候，如果发生消息中间件出现错误未及时提交消费信息，导致发生重复消费。


使用幂等性最大的优势在于使接口保证任何幂等性操作，免去因重试等造成系统产生的未知的问题。


## 四、Restful API 接口的幂等性
现在流行的 Restful 推荐的几种 HTTP 接口方法中，分别存在幂等行与不能保证幂等的方法，如下：


√ 满足幂等


x 不满足幂等


- 可能满足也可能不满足幂等，根据实际业务逻辑有关




|方法类型|是否幂等|描述
|---|---|---
|Get|√|Get 方法用于获取资源。其一般不会也不应当对系统资源进行改变，所以是幂等的。
|Post|×|Post 方法一般用于创建新的资源。其每次执行都会新增数据，所以不是幂等的。
|Put|-|Put 方法一般用于修改资源。该操作则分情况来判断是不是满足幂等，更新操作中直接根据某个值进行更新，也能保持幂等。不过执行累加操作的更新是非幂等。
|Delete|-|Delete 方法一般用于删除资源。该操作则分情况来判断是不是满足幂等，当根据唯一值进行删除时，删除同一个数据多次执行效果一样。不过需要注意，带查询条件的删除则就不一定满足幂等了。例如在根据条件删除一批数据后，这时候新增加了一条数据也满足条件，然后又执行了一次删除，那么将会导致新增加的这条满足条件数据也被删除。


## 解决方案
### 利用数据库表唯一索引
适用：新增
优点：使用方便，不需要引入其他组件增加系统的复杂性
缺点：不适用于修改
使用数据库唯一主键完成幂等性时需要注意的是，该主键一般来说并不是使用数据库中自增主键，而是使用**分布式 ID** 充当主键，**这样才能能保证在分布式环境下 ID 的全局唯一性**。
### 分布式锁
作用：保证并发下的幂等，业务层面幂等的解决方案是使用分布式锁，但是要注意分布式锁本身不解决幂等问题，解决的是并发问题，解决幂等的是代码中的重复判断
适用：修改，删除
优点：
缺点：使请求串行化，降低了系统的性能，引入了第三方组件

### 防重 Token 令牌
![image](https://pic2.zhimg.com/80/v2-8f795ffcd8abee2ad6ef95ba44c90ced_1440w.jpg)
① 服务端提供获取 Token 的接口，该 Token 可以是一个序列号，也可以是一个分布式 ID 或者 UUID 串。


② 客户端调用接口获取 Token，这时候服务端会生成一个 Token 串。


③ 然后将该串存入 Redis 数据库中，以该 Token 作为 Redis 的键（注意设置过期时间）。


④ 将 Token 返回到客户端，客户端拿到后应存到表单隐藏域中。


⑤ 客户端在执行提交表单时，把 Token 存入到 Headers 中，执行业务请求带上该 Headers。


⑥ 服务端接收到请求后从 Headers 中拿到 Token，然后根据 Token 到 Redis 中查找该 key 是否存在。


⑦ 服务端根据 Redis 中是否存该 key 进行判断，如果存在就将该 key 删除，然后正常执行业务逻辑。如果不存在就抛异常，返回重复提交的错误信息。

### 状态标识

将每个节点做一个状态标识，完成则更新节点状态，这样下一个请求进来都需要判断下节点状态，正确才继续下一步。


